name: Set PR Title from README in Branch

on:
  pull_request:
    types: [opened]

permissions:
  contents: read
  pull-requests: write

jobs:
  set_title:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'qu')
    steps:
      - name: Extract Challenge ID from branch name
        id: extract_id
        run: |
          challenge_id=$(echo "${{ github.head_ref }}" | cut -d'-' -f1)
          echo "id=$challenge_id" >> $GITHUB_OUTPUT

      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Set PR title from README
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CHALLENGE_ID: ${{ steps.extract_id.outputs.id }}
        run: |
          SOLVER_NAME=$(echo "${{ github.head_ref }}" | cut -d'-' -f2-)

          README_PATH="README.md"

          if [ ! -f "$README_PATH" ]; then
            echo "README file not found at $README_PATH. Skipping title update."
            exit 0
          fi

          first_line=$(head -n 1 "$README_PATH")

          # 末尾の絵文字やスペースの有無に対応した正規表現
          challenge_title=$(echo "$first_line" | sed -E -n 's/^## 課題：(.*)$/\1/p' | xargs)

          if [ -z "$challenge_title" ]; then
            echo "Could not extract title from README. Skipping title update."
            exit 0
          fi

          new_title="【${CHALLENGE_ID}】${challenge_title} by ${SOLVER_NAME}"

          echo "Setting PR title to: $new_title"
          gh pr edit $PR_NUMBER --title "$new_title"